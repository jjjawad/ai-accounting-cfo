Step 11.1 — Define Bank Statement Parsing Configs
Description:
- Add config file(s) for supported bank formats (CSV/PDF hints): column mappings, date formats, delimiter, sign conventions, known headers for Wio/FAB/ADCB/etc. Include default fallback mapping.
Expected Output:
- `backend/lib/bank/formats.ts` (or similar) exporting mapping definitions and detection helpers.
Testing Instructions:
- Run `npm run lint`; optionally feed sample headers to detection helper in a temporary script to verify selected format.
Dependencies:
- Master Doc sample formats, Step 7 scaffolds, Step 8 schema.

Step 11.2 — Implement CSV Parser for Bank Transactions
Description:
- Build parser to read CSV uploads (from `files` records) using format mappings; convert rows into normalized transaction objects with date, amount (signed), description, currency, account.
Expected Output:
- Parser function returning typed transaction array and parse errors; handles thousand separators and negative formats.
Testing Instructions:
- Run parser against sample CSV fixtures; verify parsed array matches expected fields and counts; ensure errors captured for bad rows.
Dependencies:
- Step 11.1, Step 10.2 (file retrieval), Step 8.6 (transaction fields).

Step 11.3 — Implement Basic PDF Parsing Hook
Description:
- For PDF statements, reuse OCR text (Step 10) and map to transactions via regex/rule-based extraction aligned with format config; mark unsupported PDFs gracefully.
Expected Output:
- Function returning parsed transactions or a clear “unsupported”/“manual review” flag.
Testing Instructions:
- Use a sample PDF OCR text fixture; confirm extraction returns rows or flagged unsupported; no runtime errors.
Dependencies:
- Steps 10.3 (OCR text), 11.1 (format hints).

Step 11.4 — Persist Parsed Transactions to DB
Description:
- Insert parsed transactions into `bank_transactions` table with status `raw`, linking to `company_id`, `bank_account_id` (resolved or default), and `source_file_id`.
Expected Output:
- DB rows created for each parsed transaction; duplicates avoided via checksum or (file_id, line_no) unique constraint if defined.
Testing Instructions:
- Process a sample statement; query `bank_transactions` and verify row count and linkage to file; ensure status `raw`.
Dependencies:
- Step 11.2/11.3, Step 8.6, Step 8.5 (files).

Step 11.5 — Add Parse Error Logging & Partial Success Handling
Description:
- Capture and store parse errors/warnings (e.g., in `system_logs` with context or a `files.parse_errors` JSON field); continue inserting valid rows.
Expected Output:
- Logs for failed rows with reasons; file record updated with counts (parsed, failed).
Testing Instructions:
- Process a CSV with a few bad lines; verify successful rows inserted and logs exist for failures; file metadata shows counts.
Dependencies:
- Steps 11.2–11.4, Step 9.9 (logging).

Step 11.6 — Wire Process Endpoint to Launch Parsing
Description:
- Extend `/api/files/:id/process` to branch: if file type is `bank_statement`, run parsing pipeline after OCR (if needed) or directly for CSV; update file status to `parsed`.
Expected Output:
- Bank statement files move to `parsed`; transactions created; other file types continue to doc extraction flow.
Testing Instructions:
- Upload CSV statement, trigger process; confirm status `parsed` and transactions inserted; non-bank files still follow doc pipeline.
Dependencies:
- Steps 9.5, 10.3, 11.2–11.5.

Step 11.7 — Expose Processed Transactions to Frontend
Description:
- Update frontend Transactions page to fetch from `/api/transactions` (now backed by DB data) instead of pure mock, with fallback to mock in dev if empty.
Expected Output:
- Transactions UI renders real parsed data when available; mock data used only if no records (optional).
Testing Instructions:
- After processing a statement, refresh Transactions page; verify parsed rows appear; check network call hits backend.
Dependencies:
- Step 5 hooks, Step 6 mock wiring, Step 11.4 data present.

Step 11.8 — Add Duplicate Prevention & Idempotency
Description:
- Introduce checksum logic (e.g., hash of date+amount+description+account) to avoid inserting duplicates on reprocess; enforce unique constraint.
Expected Output:
- Duplicate rows skipped with log entries; unique constraint/index added if not already.
Testing Instructions:
- Re-run processing on same file; row count should not increase; logs should indicate skips.
Dependencies:
- Step 11.4, Step 8.12 (indexes/constraints).

Step 11.9 — Update Build Log & Clean Debug Helpers
Description:
- Document Step 11 completion in `buildlog.md`; remove temporary fixtures/imports left in code.
Expected Output:
- Build log entry added; codebase clean.
Testing Instructions:
- `npm run lint`/`npm run build` pass; buildlog contains Step 11 notes.
Dependencies:
- Steps 11.1–11.8.
