Step 20.1 — Error Taxonomy & Messaging
Description:
- Define common error codes/messages aligned with Master Doc pattern; map to user-friendly text vs internal details.
Expected Output:
- Error constants/types module; guidance on user-facing vs internal messages.
Testing Instructions:
- `npm run lint`; confirm codes available to endpoints.
Dependencies:
- Step 7.4 response helpers.

Step 20.2 — Global API Error Middleware/Wrapper
Description:
- Add a wrapper for API handlers to catch errors, log context, and return standardized responses.
Expected Output:
- All API routes use wrapper; consistent JSON errors.
Testing Instructions:
- Trigger a known error; verify standardized response and log entry.
Dependencies:
- Steps 7 (routes), 20.1.

Step 20.3 — Frontend Error States & Banners
Description:
- Implement shared error UI component; apply to key pages (dashboard, transactions, documents, VAT, chat) to show friendly errors and retry controls.
Expected Output:
- Visible error banners/cards when queries fail; retry button triggers refetch.
Testing Instructions:
- Simulate backend failure (disable endpoint) and confirm error UI appears with retry working after service restored.
Dependencies:
- Step 5 hooks, Step 4 UIs.

Step 20.4 — Retry & Backoff for Critical Calls
Description:
- Configure React Query retry/backoff for critical endpoints (upload/process excluded) with sensible limits; ensure idempotent operations not retried excessively.
Expected Output:
- Query defaults updated; mutations configured with no/limited retry as appropriate.
Testing Instructions:
- Force transient failure; verify retry count/backoff via DevTools; ensure mutations don’t double-submit.
Dependencies:
- Step 5.11 (cache policies), Step 7/9 endpoints.

Step 20.5 — OCR/LLM Failure Handling & Retries
Description:
- Add retry and fallback logic for OCR/LLM calls with capped attempts; mark files failed after threshold and notify via logs.
Expected Output:
- Failed processing transitions to `failed` with error logged; retry count respected.
Testing Instructions:
- Force OCR/LLM failure; confirm retries limited and final status `failed`; check logs.
Dependencies:
- Steps 10.3–10.6, Step 9.9 logging.

Step 20.6 — Transaction/Categorization/Reconciliation Error Paths
Description:
- Ensure pipelines catch errors per item, skip/flag problematic records, and continue processing others; store error details on items or logs.
Expected Output:
- Individual failures flagged with reasons; batch continues; summary returned.
Testing Instructions:
- Inject bad data into batch; run pipeline; confirm failures flagged and rest processed.
Dependencies:
- Steps 11–13 pipelines, Step 8.11 logs.

Step 20.7 — PDC/VAT Edge Case Handling
Description:
- Add checks for invalid dates/amounts in PDCs and VAT periods; return clear errors; prevent processing when invalid.
Expected Output:
- Validation errors surfaced; no DB writes on invalid input.
Testing Instructions:
- Submit invalid PDC/VAT requests; verify 400 and no DB changes.
Dependencies:
- Steps 8.8, 14, 7.4 responses.

Step 20.8 — Background Job Monitoring Hooks
Description:
- Add lightweight instrumentation/logging around background jobs (processing, categorization, reconciliation) with durations and outcomes for observability.
Expected Output:
- Logs for job start/finish/error with timing; optional metrics counters.
Testing Instructions:
- Run jobs; check logs for timing entries; ensure errors captured.
Dependencies:
- Steps 9–15 jobs, Step 8.11 logs.

Step 20.9 — Update Build Log & Cleanup
Description:
- Document Step 20 in `buildlog.md`; remove temporary error simulations/logs.
Expected Output:
- Build log updated; clean code.
Testing Instructions:
- `npm run lint`/`npm run build`; verify buildlog entry.
Dependencies:
- Steps 20.1–20.8.
