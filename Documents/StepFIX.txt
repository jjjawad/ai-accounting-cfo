---

## MISSION — Sub-Step FIX — Convert `backend/` into a Real Next.js API App

## GOAL

Turn the existing `backend/` folder (which currently only has placeholder npm scripts and API route code) into a **minimal, runnable Next.js API project**. After this sub-step, you must be able to:

* Run `npm run dev` inside `backend/` and get a real dev server.
* Hit existing routes under `backend/app/api/...` (e.g. `/api/debug-supabase`) via HTTP.

No business logic changes — just scaffolding so the backend can actually execute the Step 7 & Step 9 API routes.

## CONTEXT (ALREADY LOADED)

* The repo already contains:

  * `backend/` folder with:

    * `package.json` that only echoes “Backend dev placeholder”.
    * `app/api/.../route.ts` files created in earlier steps (e.g. `debug-supabase`, `files/upload`, `files/[id]/process`).
  * `frontend/` Next.js app, which is already deployed to Vercel.
  * Master Document and Steps Document describing:

    * Backend as a separate serverless Next/Vercel project for APIs.
    * Step 7 (backend scaffolding) and Step 9 (file upload pipeline) as backend responsibilities.
* Build Log notes that backend scripts are placeholders and that backend routes have been implemented but not actually run.

The IDE must **not** touch the Master Document, Steps Document, or Build Log directly; only code and config.

## SCOPE RULES

* Implement **only** Sub-Step FIX:

  * Convert `backend/` into a runnable Next.js API project (App Router).
  * Preserve all existing backend API route files and their logic.
* Do **NOT**:

  * Modify frontend code.
  * Modify any API route logic in `backend/app/api/**` (unless a tiny import tweak is absolutely required to make the app compile).
  * Change database/schema code.
  * Add UI beyond a minimal placeholder page.
* You **may**:

  * Modify `backend/package.json`.
  * Add minimal Next.js config files (`tsconfig.json`, `next.config.mjs`, `next-env.d.ts`).
  * Add an `app/page.tsx` (simple placeholder) if required by Next.

## IMPLEMENTATION INSTRUCTIONS

* **1. Update `backend/package.json` to a real Next.js app**

  * File: `backend/package.json`
  * Replace the existing placeholder scripts with Next.js scripts:

    * `"dev": "next dev"`
    * `"build": "next build"`
    * `"start": "next start"`
  * Ensure `dependencies` include at least:

    * `"next": "<appropriate version>"` (e.g. `"14.x"` or `"latest"`)
    * `"react": "^18.x"`
    * `"react-dom": "^18.x"`
    * `"@supabase/supabase-js": "^2.86.2"` (already present)
    * `"zod": "^4.1.13"` (already present)
  * Add `devDependencies` for TypeScript and types:

    * `"typescript"`
    * `"@types/node"`
    * `"@types/react"`
    * `"@types/react-dom"`
  * Do **not** change the `"name"`, `"version"`, or `"private"` flags.

* **2. Add a minimal Next.js config**

  * Create `backend/next.config.mjs` with a minimal Next config, for example:

    * Enable App Router default, no custom aliases.
    * Optionally set `output: "standalone"` to support Vercel deployment.
  * The config should be simple — no experimental features, no rewrites/redirects.

* **3. Add TypeScript config for App Router**

  * Create `backend/tsconfig.json` that:

    * Uses `strict` TypeScript mode.
    * Extends standard Next.js TS settings (e.g. `"jsx": "preserve"`, `"moduleResolution": "bundler"` or compatible with your Next version).
    * Includes `./app` and `./**/*.ts` / `./**/*.tsx` in `"include"`.
  * Make sure this config does **not** conflict with your repo root TS config (if any). Keep it self-contained in `backend/`.

* **4. Add Next.js environment stub**

  * Create `backend/next-env.d.ts` with the standard Next content:

    * Reference `next` and `next/types/global`.
  * This file is usually auto-generated by Next, but creating it up front is fine.

* **5. Ensure `backend/app` structure is valid for App Router**

  * Confirm that the `backend/app` folder already exists (it should, because the API routes live under `backend/app/api/...`).
  * If there is **no** root page yet:

    * Create `backend/app/page.tsx` with a trivial server component, e.g.:

      * Renders “Backend OK” or “AI Accounting Backend”.
    * This page is just to ensure the app has a root route; it is not part of the product UI.

* **6. DO NOT change existing API routes**

  * Verify the existing routes are still in place:

    * `backend/app/api/debug-supabase/route.ts`
    * `backend/app/api/files/upload/route.ts`
    * `backend/app/api/files/[id]/process/route.ts`
    * Any other Step 7 placeholders (e.g. `/api/ping`, `/api/health`, etc.).
  * Do **not** change their logic as part of this mission.
  * Only adjust imports if absolutely necessary to fix TypeScript/Next compilation (e.g., change a broken absolute import to relative). Keep changes minimal and localized.

* **7. Install dependencies and verify local dev server starts**

  * From the `backend/` directory:

    * Run `npm install`.
    * Then run `npm run dev`.
  * Confirm the dev server starts successfully:

    * No immediate TypeScript errors in the terminal.
    * It outputs a local URL like `http://localhost:3000` or `http://localhost:3001` (depending on port).

* **8. Sanity-check that existing API routes are now live**

  * With the backend dev server running:

    * Visit `http://localhost:<backend-port>/api/debug-supabase` in a browser.

      * If env vars are **not** set yet, it may return an error JSON — that is acceptable for this mission as long as:

        * The route executes, and
        * You see a JSON response (not a 404 and not a Next crash).
      * If env vars are set correctly, it should ideally return an `{ ok: true }` style response.
    * Optionally, hit any simple health/ping route that exists (e.g. `/api/ping`) and confirm JSON response.
  * The goal is to verify that:

    * Next.js is running.
    * The `app/api` routes execute under the Next runtime.
    * No fatal compile/runtime errors.

* **9. Do not change env handling in this mission**

  * This mission does **not** modify `.env` files or require env correctness, only that the server starts.
  * If `/api/debug-supabase` shows a Supabase config error, that is acceptable for this sub-step. We will handle env wiring in later missions.

* **10. Prepare Build Log entry**

  * After successful dev server start and API route sanity-check:

    * Prepare a new Build Log entry for **STEP FIX** using the template in the “AUTO BUILD LOG ENTRY” section.
    * The IDE should **not** edit `buildlog.md` by itself; the human will paste the entry later.

## FILES TO CREATE

* `backend/next.config.mjs`

  * Minimal Next.js config for the backend API project.

* `backend/tsconfig.json`

  * TypeScript configuration for the backend Next project (App Router + API routes).

* `backend/next-env.d.ts`

  * Standard Next.js type declaration stub.

* `backend/app/page.tsx`

  * Minimal root page component (e.g. returns `<main>Backend OK</main>`), used only to satisfy Next’s app structure.

*(If some of these already exist, update them instead of creating duplicates.)*

## FILES TO MODIFY

* `backend/package.json`

  * Replace placeholder `dev`/`build` scripts with real Next.js scripts.
  * Add Next/React/TypeScript dependencies and devDependencies as described.

* Existing backend API route files **only if necessary** to fix compilation (imports/path issues), e.g.:

  * `backend/app/api/debug-supabase/route.ts`
  * `backend/app/api/files/upload/route.ts`
  * `backend/app/api/files/[id]/process/route.ts`
  * Any other `backend/app/api/**/route.ts` files
  * Changes must be minimal and justified by TypeScript/Next errors.

## PATCH GUIDANCE (Optional)

* **Example `package.json` scripts update (do not copy versions verbatim if your tooling prefers different ones):**

  ```json
  {
    "name": "backend",
    "version": "1.0.0",
    "private": true,
    "scripts": {
      "dev": "next dev",
      "build": "next build",
      "start": "next start"
    },
    "dependencies": {
      "next": "14.2.5",
      "react": "18.3.1",
      "react-dom": "18.3.1",
      "@supabase/supabase-js": "^2.86.2",
      "zod": "^4.1.13"
    },
    "devDependencies": {
      "typescript": "^5.5.0",
      "@types/node": "^20.12.0",
      "@types/react": "^18.2.0",
      "@types/react-dom": "^18.2.0"
    }
  }
  ```

* **Example minimal `next.config.mjs`:**

  ```js
  /** @type {import('next').NextConfig} */
  const nextConfig = {
    output: "standalone",
  };

  export default nextConfig;
  ```

* **Example minimal `app/page.tsx`:**

  ```tsx
  // backend/app/page.tsx
  export default function BackendHomePage() {
    return (
      <main style={{ padding: "2rem", fontFamily: "system-ui" }}>
        <h1>AI Accounting Backend</h1>
        <p>This is the backend API project. UI lives in the frontend app.</p>
      </main>
    );
  }
  ```

These are examples for shape and intent; adjust versions/style to match the rest of your repo.

## TESTING INSTRUCTIONS

After the IDE completes this mission:

1. **Install backend dependencies**

   * From the `backend/` directory:

     ```bash
     npm install
     ```

2. **Run the backend dev server**

   * Still in `backend/`:

     ```bash
     npm run dev
     ```
   * Confirm:

     * The command does **not** immediately exit with “Backend dev placeholder”.
     * A Next.js dev server starts and prints a local URL (e.g. `http://localhost:3000` or `http://localhost:3001`).

3. **Open the root page (optional sanity check)**

   * Visit `http://localhost:<backend-port>/` in a browser.
   * You should see the minimal “Backend OK” page (or equivalent text you configured).

4. **Verify API route execution**

   * With the dev server running:

     * Visit `http://localhost:<backend-port>/api/debug-supabase`.

       * If your Supabase env vars are configured correctly, you should see an “ok” JSON response.
       * If env vars are missing/incorrect, you may see an error JSON. That is acceptable as long as:

         * The route is hit (no 404).
         * The server does not crash.
     * Optionally, visit any other simple health route (e.g. `/api/ping`) if it exists.
   * The key check is: **Next.js is running and serving your existing `app/api` routes.**

5. **Confirm no fatal TypeScript/Next errors**

   * Watch the terminal where `npm run dev` is running:

     * There should be no unhandled exceptions or compile failures.
   * If there are minor TS warnings, they are acceptable for this step; fatal errors are not.

6. **Prepare Build Log entry**

   * Once everything above passes:

     * Open `buildlog.md`.
     * Add a new entry for **STEP FIX — Convert backend folder into real Next.js API app — Completed**, using the AUTO BUILD LOG ENTRY below.
     * Update “Files CREATED / MODIFIED / Dependencies ADDED / Config changes / Testing result / Notes” based on what actually happened.

## AUTO BUILD LOG ENTRY

STEP FIX — Convert backend folder into real Next.js API app — Completed

* Date: <fill in today’s date>
* Files CREATED:

  * backend/next.config.mjs
  * backend/tsconfig.json
  * backend/next-env.d.ts
  * backend/app/page.tsx
* Files MODIFIED:

  * backend/package.json
  * backend/app/api/debug-supabase/route.ts (only if you had to adjust imports; remove if unchanged)
  * backend/app/api/files/upload/route.ts (only if you had to adjust imports; remove if unchanged)
  * backend/app/api/files/[id]/process/route.ts (only if you had to adjust imports; remove if unchanged)
* Dependencies ADDED:

  * next@<version>
  * react@<version>
  * react-dom@<version>
  * typescript@<version>
  * @types/node@<version>
  * @types/react@<version>
  * @types/react-dom@<version>
* Config changes:

  * Added Next.js config (`backend/next.config.mjs`) and TypeScript config (`backend/tsconfig.json`) to turn `backend/` into a standalone Next.js API project suitable for Vercel deployment.
* Testing result:

  * Ran `npm install` and `npm run dev` in `backend/`. Confirmed that a Next.js dev server starts without fatal errors. Visited `http://localhost:<backend-port>/` and saw the minimal “Backend OK” page. Called `http://localhost:<backend-port>/api/debug-supabase` and confirmed the route executes and returns JSON (either success or a Supabase configuration error, depending on env setup), proving that `app/api` routes are being served by the backend Next project.
* Notes:

  * This sub-step converts the `backend/` folder from a placeholder into a real Next.js API app while preserving all existing API route implementations from Steps 7 and 9. Future steps can now deploy `backend/` as a separate Vercel project and wire the frontend project to these backend APIs via a `NEXT_PUBLIC_BACKEND_URL`.
