Step 21.1 — Define Notification Types & Triggers
Description:
- List required notifications (e.g., VAT reminders, failed processing, missing documents) and triggers (cron, event hooks) per Master Doc. Document content templates.
Expected Output:
- Notification spec document/config enumerating types, triggers, and templates placeholders.
Testing Instructions:
- Review spec for completeness; no code execution needed.
Dependencies:
- Steps 14 (VAT), 9/10 (processing), 18 (admin visibility).

Step 21.2 — Configure n8n Cron/Workflows
Description:
- Set up n8n workflows (or config placeholders) for scheduled checks (daily processing status, VAT deadlines). Store webhook URLs/IDs in env/config.
Expected Output:
- Workflows created or documented with IDs; env variables updated for hooks.
Testing Instructions:
- Trigger workflow manually; verify it runs and can call back API; check logs.
Dependencies:
- Step 7.11 (webhook handler), Step 1.7 (n8n setup).

Step 21.3 — Backend Notification Service Wrapper
Description:
- Implement email notification helper (Resend/SendGrid) reading from env; support templated subjects/bodies and company scoping.
Expected Output:
- Helper functions `sendEmail(to, template, data)` with error handling and dry-run option in dev.
Testing Instructions:
- Send a test email in dev/dry-run; verify log/output; ensure real send works with valid credentials (optional).
Dependencies:
- Step 7.1 env, Master Doc email provider, Step 7.4 responses.

Step 21.4 — Processing Failure Notifications
Description:
- On file processing failure (Step 10), trigger notification to operators/admin; include file_id, company, and error summary.
Expected Output:
- Email/log notification sent when processing fails; deduplicated per file.
Testing Instructions:
- Force a processing failure; confirm notification/log emitted once.
Dependencies:
- Steps 10.6, 9.9 logging, 21.3.

Step 21.5 — VAT Deadline Reminder Notifications
Description:
- Implement scheduled check to send reminders X days before VAT period end; respect company settings and opt-out flags.
Expected Output:
- Reminders generated and sent; recorded in logs; no duplicates within window.
Testing Instructions:
- Mock current date near period end; run job; verify reminder email/log; ensure rerun does not spam.
Dependencies:
- Step 14 (vat_returns), 21.2 cron, 21.3 email.

Step 21.6 — Missing Documents/Unmatched Items Alerts
Description:
- Send periodic alerts for unmatched transactions or missing documents/uploads within a period threshold.
Expected Output:
- Alerts contain counts and links to admin review; throttled to avoid spam.
Testing Instructions:
- Create unmatched items; run job; verify alert content; rerun to ensure throttling.
Dependencies:
- Steps 11–13 data, 21.2 cron, 21.3 email.

Step 21.7 — User Invitations & Access Emails
Description:
- Implement invite flow emails with token links; triggered from Settings invitations UI (Step 4.7) when backend invite endpoint is ready.
Expected Output:
- Invite endpoint sends email with token; stored invite record; handles resend.
Testing Instructions:
- Send invite; verify email receipt/log; token stored; resend works and rate-limited.
Dependencies:
- Step 7 auth foundation, Step 5/4 settings UI, Step 21.3 email.

Step 21.8 — Logging & Opt-Out Controls
Description:
- Log all sends to system_logs with type/status; add per-company/user opt-out flags honored by jobs.
Expected Output:
- Logs per notification; opt-out flags stored and enforced.
Testing Instructions:
- Enable opt-out then trigger job; confirm no email sent and log indicates skipped; disable opt-out and verify send.
Dependencies:
- Step 8.11 logs, Step 8 schema (add opt-out fields if missing), Steps 21.3–21.6.

Step 21.9 — Update Build Log & Cleanup
Description:
- Document Step 21 in `buildlog.md`; remove temporary test sends.
Expected Output:
- Build log updated; clean codebase.
Testing Instructions:
- `npm run lint`/`npm run build`; confirm buildlog entry.
Dependencies:
- Steps 21.1–21.8.
