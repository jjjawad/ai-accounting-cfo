Step 13.1 — Define Reconciliation Rules & Tolerances
Description:
- Create config for matching logic: date window, amount tolerance, vendor similarity thresholds, priority order. Align with Master Doc defaults.
Expected Output:
- Config module exporting tolerances and matching strategy notes.
Testing Instructions:
- `npm run lint`; confirm values via temporary log (remove after).
Dependencies:
- Step 8 schema, Step 12 thresholds, Master Doc rules.

Step 13.2 — Implement Candidate Matching Engine
Description:
- Build function that, given a bank transaction, returns candidate invoices/receipts/PDCs based on amount/date/vendor similarity. Include scoring and sort by best match.
Expected Output:
- Helper returns ordered candidate list with scores and reasons.
Testing Instructions:
- Run function against fixtures; inspect output to ensure scoring/order make sense; no runtime errors.
Dependencies:
- Steps 8.6 (transactions), 8.7 (invoices), 8.8 (PDCs), 13.1 config.

Step 13.3 — Auto-Match High-Confidence Transactions
Description:
- Create pipeline that auto-links transactions when top candidate score exceeds threshold; update transaction status to `reconciled`, set links (invoice_id/pdc_id), and write logs.
Expected Output:
- DB updates reflect reconciled links; low-scoring items left untouched.
Testing Instructions:
- Run pipeline on sample data; verify reconciled count and DB links; check logs for actions.
Dependencies:
- Step 13.2, Step 8.6, Step 8.7/8.8.

Step 13.4 — Manual Reconciliation API for Review Queue
Description:
- Add endpoint (e.g., `POST /api/transactions/:id/reconcile`) to accept selected link (invoice_id/pdc_id) from admin UI; enforce auth/admin role.
Expected Output:
- Endpoint updates transaction linkage and status; returns success or validation error.
Testing Instructions:
- `curl` endpoint with a transaction and invoice IDs; confirm DB updates and status change; ensure unauthorized requests fail.
Dependencies:
- Step 13.3, Step 7.3 (auth with admin flag), Step 7.4.

Step 13.5 — Handle Partial Matches & Ambiguity
Description:
- Add logic to mark ambiguous items as `needs_review`, storing candidate summary for UI; avoid auto-match when multiple close scores.
Expected Output:
- Ambiguous transactions flagged with candidate metadata; no incorrect auto-links.
Testing Instructions:
- Provide transactions with two near-equal candidates; verify status `needs_review` and candidate list stored for admin view.
Dependencies:
- Steps 13.2–13.3.

Step 13.6 — Update Frontend Transactions & Admin Review UI
Description:
- Surface reconciliation status and linked document info on Transactions page; in Admin review, allow selecting a candidate and submitting manual reconciliation via new endpoint.
Expected Output:
- UI shows reconciled/needs_review badges; admin can choose a candidate and see updated status post-submit.
Testing Instructions:
- In UI, view a reconciled transaction; ensure linked doc info appears. In admin review, select a candidate → submit → status updates and disappears from review queue.
Dependencies:
- Steps 13.4–13.5, Step 4.9 (review UI), Step 5 hooks.

Step 13.7 — Add Unmatched/Exception Logging
Description:
- Log unmatched transactions with reasons (no candidates, below threshold) to `system_logs` for operator monitoring.
Expected Output:
- Logs created for unmatched items with context; counts available via admin logs endpoint.
Testing Instructions:
- Run pipeline; check logs table for unmatched entries; ensure context includes transaction id and reasons.
Dependencies:
- Steps 13.2–13.3, Step 9.9 logging pattern.

Step 13.8 — Idempotency & Re-run Safety
Description:
- Ensure re-running reconciliation skips already reconciled unless `force` flag is set; guard against duplicate links.
Expected Output:
- Safe re-runs with skipped counts; optional force mode documented.
Testing Instructions:
- Run reconciliation twice on same dataset; confirm second run reports skips, no duplicate updates.
Dependencies:
- Steps 13.3–13.5.

Step 13.9 — Update Build Log & Clean Debugging
Description:
- Add Step 13 summary to `buildlog.md`; remove temporary fixtures/logs.
Expected Output:
- Build log updated; clean codebase.
Testing Instructions:
- `npm run lint`/`npm run build`; ensure buildlog updated.
Dependencies:
- Steps 13.1–13.8.
