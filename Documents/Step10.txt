Step 10.1 — Configure OCR & LLM Client Utilities
Description:
- Add backend helpers for Google Vision OCR and OpenAI extraction (per Master Doc). Read keys/credentials from env, expose typed functions for OCR text and structured extraction calls.
Expected Output:
- `backend/lib/ocr.ts` and `backend/lib/ai/extraction.ts` (or similar) with initialized clients and error handling.
Testing Instructions:
- Run `npm run lint/build`; optionally call helpers in a temporary script with a tiny sample image/text to ensure credentials load (remove test afterward).
Dependencies:
- Step 7.1 (env), Step 7.2 (Supabase client), Step 9 (file upload).

Step 10.2 — Fetch File From Storage for Processing
Description:
- Implement utility to retrieve uploaded file bytes from Supabase storage given `file_id` (using `files` table lookup) for OCR pipeline use.
Expected Output:
- Function `getFileBuffer(fileId)` returns buffer/metadata or throws; used by process route/worker.
Testing Instructions:
- Run a temporary script invoking `getFileBuffer` for a known file; confirm buffer length > 0.
Dependencies:
- Step 9 (files stored), Step 8.5 (files table).

Step 10.3 — Implement OCR Extraction Pipeline Step
Description:
- Create a worker/route handler that: loads file, calls Vision OCR, stores raw OCR text in `files.ocr_text` (or related column), and updates status to `ocr_completed`.
Expected Output:
- OCR text persisted in DB; file status updated; logs recorded.
Testing Instructions:
- Trigger process for a PDF/image; verify `ocr_text` populated in DB and status updated; no errors in server logs.
Dependencies:
- Steps 10.1, 10.2, Step 8 schema includes ocr_text/status.

Step 10.4 — Implement AI-Based Document Structuring
Description:
- After OCR, call OpenAI to transform text into structured invoice/receipt JSON per Master Doc fields (vendor, date, amount, VAT, line items). Include validation with Zod schema.
Expected Output:
- Structured JSON object produced and validated; errors handled with retries/fallback message.
Testing Instructions:
- Process a sample file; inspect logs/DB to confirm structured object passes validation; failure path returns clear error.
Dependencies:
- Step 10.1, Step 10.3, Step 8.7 (invoice tables exist), Zod available from Step 5/7.

Step 10.5 — Persist Invoice/Receipt Records From Extraction
Description:
- Insert/update `invoices` and `invoice_line_items` based on structured output, linking to `files` row and vendor/category if available.
Expected Output:
- DB rows for invoice + line items created with correct FKs (company_id, vendor_id, file_id).
Testing Instructions:
- Process file; query `invoices`/`invoice_line_items` to confirm records and linkage to file/vendor.
Dependencies:
- Step 10.4, Step 8.7 (tables), Step 8.4 (vendors).

Step 10.6 — Update File Status & Error Handling
Description:
- Transition file status through `processing`, `ocr_completed`, `extracted`, `failed`; record error messages on failure; write system_logs.
Expected Output:
- `files.status` reflects latest step; errors captured in `files.error` (or log) and system_logs entries created.
Testing Instructions:
- Force an error (e.g., invalid file) and confirm status `failed` + error message stored; success path shows `extracted`.
Dependencies:
- Steps 10.3–10.5, Step 9.9 (logging).

Step 10.7 — Wire n8n Webhook to Trigger OCR Pipeline
Description:
- Update process endpoint/webhook handler to call the internal OCR/extraction pipeline when n8n triggers (or directly if no queue). Accept webhook payload with file_id and start processing.
Expected Output:
- Webhook calls start processing; responses return queued/started; idempotent guard prevents double-processing.
Testing Instructions:
- Hit webhook with file_id; ensure pipeline runs once and statuses update; repeat call returns already-processed response.
Dependencies:
- Step 9.5 (process endpoint), Steps 10.3–10.6.

Step 10.8 — Surface Processing Status in Frontend
Description:
- Update Documents UI to poll or refetch file list showing statuses (`uploaded`, `processing`, `extracted`, `failed`) and error badges.
Expected Output:
- Users see live-ish status updates and error indicators on Documents page.
Testing Instructions:
- Upload and process a file; watch UI update; confirm error badge appears for failed sample.
Dependencies:
- Step 9.6 (UI wired), backend statuses from Step 10.6.

Step 10.9 — Add Minimal Unit/Integration Tests (Optional)
Description:
- Add small tests for OCR helper and schema validation using sample OCR text; mock external APIs where needed.
Expected Output:
- Test files under backend tests pass; mocks prevent real API calls in CI.
Testing Instructions:
- Run `npm run test` (or equivalent) and ensure green.
Dependencies:
- Steps 10.1–10.4.

Step 10.10 — Update Build Log & Remove Temporary Debugging
Description:
- Document Step 10 completion in `buildlog.md`; remove temporary console logs or sample scripts.
Expected Output:
- Build log entry added; clean codebase with no stray debug statements.
Testing Instructions:
- `npm run lint`/`npm run build` pass; buildlog shows Step 10 notes.
Dependencies:
- Steps 10.1–10.9.
